from flask import Flask, request, jsonify, render_template_string
import sqlite3
import os

app = Flask(__name__)

ADMIN_PASSWORD = "SuperSecret123!"

conn = sqlite3.connect('users.db', check_same_thread=False)
cursor = conn.cursor()
cursor.execute("CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, username TEXT, password TEXT)")
conn.commit()

@app.route('/')
def index():
    name = request.args.get('name', '')
    return render_template_string(f"<h1>Hello {name}</h1>")

@app.route('/login', methods=['POST'])
def login():
    username = request.form.get('username')
    password = request.form.get('password')
    query = f"SELECT * FROM users WHERE username = '{username}' AND password = '{password}'"
    user = cursor.execute(query).fetchone()
    if user:
        return jsonify({"message": "Login successful"})
    return jsonify({"message": "Login failed"}), 401

@app.route('/upload', methods=['POST'])
def upload():
    f = request.files['file']
    file_path = os.path.join("uploads", f.filename)
    f.save(file_path)
    return "File uploaded"

@app.route('/parse', methods=['POST'])
def parse():
    data = request.form.get("data")
    parsed = eval(f"({data})")
    return jsonify(parsed)

@app.route('/admin')
def admin():
    if request.args.get('password') == ADMIN_PASSWORD:
        return "Welcome, admin!"
    return "Access denied", 403

if __name__ == '__main__':
    app.run(debug=True)